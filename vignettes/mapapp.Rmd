---
title: "Introduction to mapapp"
author: "Chris Comiskey"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo = FALSE, warning = FALSE, message = FALSE}
# library(shiny)
library(mapapp)
# library(ggplot2)
# library(dplyr)
```

Welcome to the mapapp vignette. If you don't have mapapp yet, you can download it from GitHub.

```{r, warning = FALSE, message = FALSE, eval = FALSE}
# install.packages("devtools")
devtools::install_github('cwcomiskey/mapapp')
```

This version of mapapp provides two functions: `heatmapper()` to create heat maps with the R package ggplot, and `shinyHMCI()` to create interactive heat map confidence intervals (HMCIs) with the R package Shiny. Take a look!

```{r, fig.height=2, fig.width=2, eval = FALSE}
mapapp::shinyHMCI(FinalList)
```

Shiny and ggplot2 create graphics with unlimited variety, but `heatmapper()` and `shinyHMCI()` offer an expedient shortcut if you want to quickly create heat maps and launch interactive HMCIs. The key to using mapapp is data formatting. 

## Formatting for `shinyHMCI()`

Heat maps work by mapping a statistic of interest to a color at a set of (x,y) domain locations; call this number of locations $n$. The mapapp dataset `listn` uses $n = 3500$ locations. `shinyHMCI()` needs data for the point estimate map, and for every CI level---1\% through 99\%. Accordingly, `shinyHMCI()` requires a list with 100 elements, each a data frame with $n$ rows. 

* The first data frame includes three variables/columns:
    + `x` - horizontal spatial coordinate
    + `y` - vertical spatial coordinate
    + `stat` - heat map statistic for each $(x,y)$ location
* The remaining i = 1:99 data frames include two variables: 
    + `lb` - lower bound for the i$\%$ CI.
    + `ub` - upper bound for the i$\%$ CI

There are four primary steps to format your data for `shinyHMCI(...)`.

### Step 1: Create a List

We start with mapapp data frame `df0`, and create a list called `fun` with `df0` as its first element.

```{r, eval = FALSE}
head(InitialDF)
fun <- list(InitialDF)
str(fun)
```

Now we need to add a data frame with the upper and lower bounds, for each of the 99 levels of confidence, to `fun`. 

### Step 2: Calculate Confidence Bounds

You can add the bounds to your list however you wish, as long as each list element is a data frame of two columns named `lb` and `ub`. I use a loop function to calculate my bounds, with the following basic structure:

1. Define index i = 1:99
2. For an i = 1\% CI, calculate the lower bounds (lb) and upper bounds (ub) for all $n$ points in your domain. 
3. Create $n \times 2$ data frame $[[\text{lb}, \text{ub}]]$, and save it as element i + 1 of `fun`. 
4. Repeat for i = 2:99, until `fun` is a 100 element list.

In code, this loop algorithm might look like this.

```{r, eval = FALSE}
  for(i in 1:99){
    fun[[i+1]] <- data.frame(
      lb = calculate_lower(i, other_arguments), 
      ub = calculate_upper(i, other_arguments)
      )
  }
```

`calculate_lower` and `calculate_upper` will be the method or function you use to calculate the lower and upper bounds for each confidence level. When you're done you'll have something like mapapp's dataset `list0`. 

```{r, eval = FALSE}
head(InitialList[[1]]) # data frame with coordinates, point estimate
head(InitialList[[2]]) # data frame with lower, upper bounds
```

### Step 3: Rename Coordinates and Point Estimates

Now select and rename the coordinates and point estimates in the first data frame of your list.

```{r}
InitialList[[1]] <- dplyr::select(InitialList[[1]], x = px, y = pz, stat = phat)
head(InitialList[[1]]) 
```

## Create Interactive App

With your data in this structure, `shinyHMCI()` will create an interactive HMCI.

```{r, eval = FALSE}
shinyHMCI(FinalList)
```

## Future Improvments

Future versions of **mapapp** will offer a function similar to the following:

* `all_in_one <- get_CI(model, x, y, levels)` - a function that creates, given the model you fit, the properly formatted confidence intervals, at the locations and levels the user specifies, so that `shinyHMCI(all_in_one)` creates a interactive HMCI in Shiny.
